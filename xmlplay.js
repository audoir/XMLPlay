"use strict";var xmlplay_VERSION=96,instUrl="",instTab={};!function(){var e,t,n,a,o,r,i,l,s,c,d,u,f,p,m,v,h,g,_,b,y,x=0,k=0,w=0,E=[],L=[],T={},A={},B=[],I=[],S=[],M=500,C=30,O=0,R=[],D=0,V=[],H=null,z=[],q=[],F={},P=100,j=null,G=[],N={},U={},Y={},X=[],K={},J=[],W=[],Q=null,Z="Your browser has no Web Audio API -> no playback.",ee=["acoustic_grand_piano","bright_acoustic_piano","electric_grand_piano","honkytonk_piano","electric_piano_1","electric_piano_2","harpsichord","clavinet","celesta","glockenspiel","music_box","vibraphone","marimba","xylophone","tubular_bells","dulcimer","drawbar_organ","percussive_organ","rock_organ","church_organ","reed_organ","accordion","harmonica","tango_accordion","acoustic_guitar_nylon","acoustic_guitar_steel","electric_guitar_jazz","electric_guitar_clean","electric_guitar_muted","overdriven_guitar","distortion_guitar","guitar_harmonics","acoustic_bass","electric_bass_finger","electric_bass_pick","fretless_bass","slap_bass_1","slap_bass_2","synth_bass_1","synth_bass_2","violin","viola","cello","contrabass","tremolo_strings","pizzicato_strings","orchestral_harp","timpani","string_ensemble_1","string_ensemble_2","synth_strings_1","synth_strings_2","choir_aahs","voice_oohs","synth_choir","orchestra_hit","trumpet","trombone","tuba","muted_trumpet","french_horn","brass_section","synth_brass_1","synth_brass_2","soprano_sax","alto_sax","tenor_sax","baritone_sax","oboe","english_horn","bassoon","clarinet","piccolo","flute","recorder","pan_flute","blown_bottle","shakuhachi","whistle","ocarina","lead_1_square","lead_2_sawtooth","lead_3_calliope","lead_4_chiff","lead_5_charang","lead_6_voice","lead_7_fifths","lead_8_bass__lead","pad_1_new_age","pad_2_warm","pad_3_polysynth","pad_4_choir","pad_5_bowed","pad_6_metallic","pad_7_halo","pad_8_sweep","fx_1_rain","fx_2_soundtrack","fx_3_crystal","fx_4_atmosphere","fx_5_brightness","fx_6_goblins","fx_7_echoes","fx_8_scifi","sitar","banjo","shamisen","koto","kalimba","bagpipe","fiddle","shanai","tinkle_bell","agogo","steel_drums","woodblock","taiko_drum","melodic_tom","synth_drum","reverse_cymbal","guitar_fret_noise","breath_noise","seashore","bird_tweet","telephone_ring","helicopter","applause","gunshot"],te={},ne=120,ae=120,oe=1,re=[],ie=[],le=1,se=0,ce=0,de=0;const ue=.5/32,fe=.5/60;var pe=1,me=1,ve=1,he=1;function ge(e){d.innerHTML+=e+"\n"}function _e(e){var t=e.slice(0,4e3);if(t.indexOf("X:")>=0)ke(e);else if(-1!=t.indexOf("<?xml ")){var n=(new window.DOMParser).parseFromString(e,"text/xml"),a={p:"f",t:1,u:0,v:3,m:2,mnum:0};se&&(a.p=""),ce&&(a.x=1);var o=vertaal(n,a);o[1]&&ge(o[1]),ke(o[0])}else alert("not an xml file nor an abc file")}function be(){var e,t=new FileReader;t.onload=function(e){_e(t.result)},(e=j?j[0]:p.files[0])&&(o=e.name.split(".")[0],t.readAsText(e))}function ye(e){d.innerHTML="";var t=e[0].link;o=e[0].name.split(".")[0],c.style.display="block",ge("link: "+t+"<br>");var n=new XMLHttpRequest;n.open("GET",t,!0),n.onload=function(){ge("XHR ok"),c.style.display="none",_e(n.responseText)},n.onerror=function(){c.innerHTML+="XHR failed<br>"},n.send()}function xe(e){e.stopPropagation(),e.preventDefault(),j=e.dataTransfer.files,this.classList.remove("indrag"),be()}function ke(o){if(o.indexOf("I:percmap")>=0&&(o=function(e){var t,n,a,o,r={diamond:1,triangle:1,square:1,normal:1},i=['%%beginsvg\n<defs>\n<text id="x" x="-3" y="0">&#xe263;</text>\n<text id="x-" x="-3" y="0">&#xe263;</text>\n<text id="x+" x="-3" y="0">&#xe263;</text>\n<text id="normal" x="-3.7" y="0">&#xe0a3;</text>\n<text id="normal-" x="-3.7" y="0">&#xe0a3;</text>\n<text id="normal+" x="-3.7" y="0">&#xe0a4;</text>\n<g id="circle-x"><text x="-3" y="0">&#xe263;</text><circle r="4" class="stroke"/></g>\n<g id="circle-x-"><text x="-3" y="0">&#xe263;</text><circle r="4" class="stroke"/></g>\n<path id="triangle" d="m-4 -3.2l4 6.4 4 -6.4z" class="stroke" style="stroke-width:1.4"/>\n<path id="triangle-" d="m-4 -3.2l4 6.4 4 -6.4z" class="stroke" style="stroke-width:1.4"/>\n<path id="triangle+" d="m-4 -3.2l4 6.4 4 -6.4z" class="stroke" style="fill:#000"/>\n<path id="square" d="m-3.5 3l0 -6.2 7.2 0 0 6.2z" class="stroke" style="stroke-width:1.4"/>\n<path id="square-" d="m-3.5 3l0 -6.2 7.2 0 0 6.2z" class="stroke" style="stroke-width:1.4"/>\n<path id="square+" d="m-3.5 3l0 -6.2 7.2 0 0 6.2z" class="stroke" style="fill:#000"/>\n<path id="diamond" d="m0 -3l4.2 3.2 -4.2 3.2 -4.2 -3.2z" class="stroke" style="stroke-width:1.4"/>\n<path id="diamond-" d="m0 -3l4.2 3.2 -4.2 3.2 -4.2 -3.2z" class="stroke" style="stroke-width:1.4"/>\n<path id="diamond+" d="m0 -3l4.2 3.2 -4.2 3.2 -4.2 -3.2z" class="stroke" style="fill:#000"/>\n</defs>\n%%endsvg'],l="default",s={default:[]};for(t=e.split("\n"),n=0;n<t.length;++n){if((a=t[n]).indexOf("I:percmap")>=0){var c=(a=a.split(" "))[4];c in r&&(c=c+"+,"+c),a="%%map perc"+l+" "+a[1]+" print="+a[2]+" midi="+a[3]+" heads="+c,s[l].push(a)}a.indexOf("V:")>=0&&(o=a.match(/V:\s*(\S+)/))&&((l=o[1])in s||(s[l]=[]))}for(l in s)i=i.concat(s[l]);for(n=0;n<t.length;++n)(a=t[n]).indexOf("I:percmap")>=0||(a.indexOf("V:")>=0||a.indexOf("K:")>=0?((o=a.match(/V:\s*(\S+)/))&&(l=o[1]),0==s[l].length&&(l="default"),i.push(a),a.indexOf("perc")>=0&&-1==a.indexOf("map=")&&(a+=" map=perc"),a.indexOf("map=perc")>=0&&s[l].length>0&&i.push("%%voicemap perc"+l),a.indexOf("map=off")>=0&&i.push("%%voicemap")):i.push(a));return i.join("\n")}(o)),o.indexOf("%%map")>=0&&(K=function(e){var t,n,a,o,r,i,l,s={};for(t=e.split("\n"),n=0;n<t.length;++n)(a=t[n]).indexOf("%%map")>=0&&(o=a.match(/%%map *(\S+) *(\S+).*midi=(\d+)/))&&(r=o[1],i=o[2],l=o[3],s[r+i]=parseInt(l));return s}(o)),o.indexOf(" strings")>=0){var r=function(e){var t,n,a,o,r,i,l,s,c={},d={},u=[18,20,22,24,26,28];for(t=e.split("\n"),n=0;n<t.length;++n)(a=t[n]).indexOf("strings")>=0&&(o=a.match(/V:\s*(\S+).*strings\s*=\s*(\S+)/))&&(s=o[1],c[s]={},o[2].split(",").forEach(function(e,t){r=e[0],i=12*parseInt(e[1]),l=i+[0,2,4,5,7,9,11]["CDEFGAB".indexOf(r)]+12,c[s][u[t]]=l}),d[s]=a.indexOf("diafret")>=0);return[c,d]}(o);r[0],r[1]}e=o,function(e){var o,r="",i=0,l=5,s=6,c=8,d=10,u=14,f=16,p=[3,0,4,1,5,2,6],v=[0,2,4,5,7,9,11];e,t=[],L=[],m.value=ae=ne=120,J=[],W=[];var h=[];(o=new Abc({img_out:null,errmsg:function(e,t,n){r+=e+"\n"},read_file:function(e){return""},anno_start:null,get_abcmodel:function(o,r,g){function _(e,t){y[e]=[0,0,0,0,0,0,0],k[e]={},w[e]=t;var n=t>=0,a=n?p.slice(0,t):p.slice(t);a.forEach(function(t){y[e][t]+=n?1:-1})}var b,y={},x={"-2":-2,"-1":-1,0:0,1:1,2:2,3:0},k={},w={},E={},T=("0,1-,1,1+,2,3,3,4,4,5,6,6+,7,8-,8,8+,9,10,10,11,11,12,13,13+,14".split(","),{ppp:30,pp:30,p:30,mp:75,mf:90,f:105,ff:120,fff:127}),A=[],B=r[0].meter.a_meter;for(B.length?parseInt(B[0].top):4,P=0;P<r.length;++P){var I=r[P].key.k_sf;_(P,I),E[P]={}}var S={};a=r.length,n=function(e){var t=[];return e.forEach(function(e,n){t[e.st]?t[e.st].push(n):t[e.st]=[n],e.clef.clef_octave&&(L[n]=e.clef.clef_octave),G[e.st]=6*(e.stafflines||"|||||").length*(e.staffscale||1),J[n]=e.midictl&&e.midictl[7],null==J[n]&&(J[n]=100),W[n]=e.midictl&&e.midictl[10],null==W[n]&&(W[n]=64),h[n]=e.instr?e.instr:0}),t}(r);for(var M=o;M;M=M.ts_next){var C,O,D,z,q,F,P,j=[];switch(M.type){case u:var N=M.tempo_notes.reduce(function(e,t){return e+t});ne=M.tempo*N/384,0==M.time&&(m.value=ae=ne);break;case d:F={t:M.time,mnum:-1,dur:M.dur},j.push(F),t.push({t:M.time,ix:M.istart,v:M.v,ns:j,inv:M.invis,tmp:ne});break;case c:var U=h[M.v];for("p"==M.p_v.clef.clef_type&&(U+=128),ee=0;ee<M.notes.length;++ee){C=M.notes[ee],O=C.pit+19,P=M.v,M.p_v.id,M.a_dd&&M.a_dd.forEach(function(e){(b=T[e.name])&&n[M.st].forEach(function(e){A[e]=b})}),b=A[P]||60,L[P]&&(O+=L[P]),D=Math.floor(O/7),z=O%7,null!=C.acc&&(k[P][O]=x[C.acc]),q=12*D+v[z]+(O in k[P]?k[P][O]:y[P][z]);var $=M.p_v.map;if(U>=128&&"MIDIdrum"!=$){var Y=e.substring(M.istart,M.iend);Y=Y.match(/[=_^]*[A-Ga-g]/)[0];var X=K[$+Y];X&&(q=X)}S[q=128*U+q]=1,F={t:M.time,mnum:q,dur:M.dur,velo:b},O in E[P]?(E[P][O].dur+=M.dur,0==C.ti1&&delete E[P][O]):(0!=C.ti1&&(E[P][O]=F),j.push(F))}if(0==j.length)break;t.push({t:M.time,ix:M.istart,v:M.v,ns:j,stf:M.st,tmp:ne});break;case l:_(M.v,M.k_sf);break;case i:_(M.v,w[M.v]),t.push({t:M.time,ix:M.istart,v:M.v,bt:M.bar_type,tx:M.text});break;case s:break;case f:M.instr&&(h[M.v]=M.instr),7==M.ctrl&&(J[M.v]=M.val),10==M.ctrl&&(W[M.v]=M.val)}}V.forEach(function(e){var t=e.parentNode;t&&t.removeChild(e)}),R=[];for(var Q=["#f9f","#3cf","#c99","#f66","#fc0","#cc0","#ccc"],ee=0;ee<a;++ee){var te=1<<ee&de?"0":"",oe=document.createElementNS("http://www.w3.org/2000/svg","rect");oe.setAttribute("fill",Q[ee%Q.length]+te),oe.setAttribute("fill-opacity","0.5"),oe.setAttribute("width","0"),V.push(oe),R.push(-1)}null!=H?qe(S):alert(Z)}})).tosvg("play","%%play"),o.tosvg("abc2svg",e),""==r&&(r="no error");ge(r)}(o),function(e){var a,o="",r="",i=0;x=0,0,A={},B=[];var c,d,u={},f=1e3,p=0;function m(e){var t,a,o,r,i,l,c,d,u,m,v;if(e.stopPropagation(),o=e.clientX,o-=this.getBoundingClientRect().left,(i=o*s)<f+24||i>p)Ie();else{for(l=I.indexOf(this),u=(e.clientY-this.getBoundingClientRect().top)*s,d=B[l],c=0;c<d.length;c++)if(d[c]>u){O=c,Ee(l);break}for(c=0;c<E.length;++c)if((t=E[c].xy)&&(v=E[c].vce,-1!=n[O].indexOf(v)&&(a=t[0],o=t[1],t[2],r=t[3],t[4],!(a<l)&&i<parseFloat(o)+r))){for(x=c,m=E[c].t;E[c]&&E[c].t==m;)Te(E[c]),c+=1;break}}}if(O=0,!e)return;(a=new Abc({imagesize:'width="100%"',img_out:function(e){-1!=e.indexOf("<svg")&&(B[i]=Object.keys(u),u={},i+=1,c<f&&(f=c),d>p&&(p=d));o+=e},errmsg:function(e,t,n){r+=e+"\n"},read_file:function(e){return""},anno_start:function(e,t,n,o,r,l,s){"note"!=e&&"rest"!=e||(o=a.ax(o).toFixed(2),r=a.ay(r).toFixed(2),s=a.ah(s),A[t]=[i,o,r,l,s]);"bar"==e&&(r=a.ay(r),s=a.ah(s),r=Math.round(r+s),u[r]=1,d=a.ax(o),c=a.ax(0))},get_abcmodel:null})).tosvg("abc2svg",e),""==r&&(r="no error\n");if(ge(r),!o)return;Q.innerHTML='<div id="leeg" style="height:'+M+'px">&nbsp;</div>',Q.innerHTML+=o,Q.innerHTML+='<div id="leeg" style="height:'+M+'px">&nbsp;</div>',je(document.getElementById("leeg"),"click",Ie),I=Array.prototype.slice.call(Q.getElementsByTagName("svg"));var v=Array.prototype.slice.call(Q.getElementsByClassName("g"));S=v.length?v:I,we(),I.forEach(function(e){l&&(e.style.display="none"),je(e,"click",m)}),function(){var e=x>0?E[x].t:0;E=[],T={};var n,a,o=1,r=0,i=0,l=0,s=0,c=0;for(n=0;n<t.length;++n){if((a=t[n]).bt&&0==a.v){if(a.t in T&&":"==a.bt[0])continue;if(1==o&&":"==a.bt[0]&&a.t>l){n=i-1,o=2,r+=a.t-l;continue}2==o&&":"==a.bt[0]&&a.t>l&&(o=1),1==o&&":"==a.bt[a.bt.length-1]&&(i=n,l=a.t),s&&(a.tx||"|"!=a.bt)&&(s=0,r-=a.t-c),2==o&&"1"==a.tx&&(s=1,c=a.t)}s||(a.bt?T[a.t]=1:E.push({t:a.t+r,xy:A[a.ix],ns:a.ns,vce:a.v,inv:a.inv,tmp:a.tmp}))}for(x=0;x<E.length&&(!((a=E[x]).t>=e)||a.inv);++x);x==E.length&&(x-=1);Te(E[x])}()}(o)}function we(){if(0!=I.length){var e,t,n,a=I[0],o=a.getBoundingClientRect().width;try{e=a.viewBox.baseVal.width}catch(t){e=o}n=(t=(t=S[0].transform)?t.baseVal:[]).numberOfItems?t.getItem(0).matrix.a:1,s=e/n/o}}function Ee(e){var t=null!=e;null==e&&(e=D);var n=f.getBoundingClientRect().top,a=I[e].getBoundingClientRect().top,o=O,r=(B[e][o]-G[o])/s,l=Math.round(Q.scrollTop+a+r-C-n);l!=Q.scrollTop&&(i&&(Q.style["scroll-behavior"]=t?"smooth":"auto"),Q.scrollTop=l),D=e}function Le(e){e.preventDefault();var t="touchstart"==e.type,n=f;function a(e){Q.getBoundingClientRect().top;var a=t?e.touches[0].clientY:e.clientY;n.style.top=a-C/2+"px",Ee()}function o(e){n.removeEventListener("mousemove",a),n.removeEventListener("touchmove",a),n.removeEventListener("mouseup",o),n.removeEventListener("touchend",o),n.removeEventListener("mouseleave",o),n.style.cursor="",n.classList.remove("spel")}n.style.cursor="row-resize",n.classList.add("spel"),n.addEventListener("mousemove",a),n.addEventListener("touchmove",a),n.addEventListener("mouseup",o),n.addEventListener("touchend",o),n.addEventListener("mouseleave",o)}function Te(e){var t,n,a,o,r,i,l,s;if(l=V[e.vce],!(t=e.xy))return l.setAttribute("width",0),void l.setAttribute("height",0);n=t[0],a=t[1],o=t[2],r=t[3],i=t[4],e.inv&&(r=0,i=0),n!=R[e.vce]&&((s=l.parentNode)&&s.removeChild(l),(s=S[n]).insertBefore(l,s.firstChild),R[e.vce]=n,Ee(n)),l.setAttribute("x",a),l.setAttribute("y",o),l.setAttribute("width",r),l.setAttribute("height",i)}function Ae(){if(H){for(var e,t=1e3*H.currentTime,n=0;0==n;){var a=E[x];a.tmp!=ae&&(ae=a.tmp,m.value=Math.round(ae*oe)),e=156.25/(a.tmp*oe),x==E.length-1?(x=-1,n=a.ns[0].dur+1e3):n=(E[x+1].t-a.t)*e,a.ns.forEach(function(n,o){n.dur<=192?e*=1.3:e*=1.1,Me(t,n.mnum,n.dur*e,a.vce,n.velo)}),Te(a),x+=1}clearTimeout(r),r=setTimeout(Ae,n)}else alert(Z)}function Be(e){switch(e.key){case"ArrowLeft":case"Left":Te(E[x-=1]);break;case"ArrowRight":case"Right":Te(E[x+=1]);break;case"ArrowUp":case"Up":Se(1);break;case"ArrowDown":case"Down":Se(-1);break;case"m":$("#mbar").click();break;case" ":e.preventDefault&&e.preventDefault(),Ie()}}function Ie(){E.length&&((k=1-k)?(y.value="Stop",b.style.display="none",Ae()):(y.value="Play",clearTimeout(r)))}function Se(e){e&&(m.value=m.value-0+e),oe=m.value/ae}function Me(e,t,n,a,o){if(-1!=t){var r=t>>7;if(r in Y)!function(e,t,n,a,o,r){var i,l,s,c,d,u,f,p,m,v,h,g,_,b,y=re[e][t];if(!y)return;var x=H.createBufferSource(),k=y.useflt,w=y.uselfo,E=y.useenv,L=J[o]/127,T=(W[o]-64)/64;x.buffer=y.buffer,y.loopStart&&(x.loop=!0,x.loopStart=y.loopStart,x.loopEnd=y.loopEnd);x.playbackRate.value=ie[e][t],w&&((d=H.createOscillator()).frequency.value=y.lfofreq,(l=H.createGain()).gain.value=y.lfo2vol,d.connect(l),(s=H.createGain()).gain.value=1,l.connect(s.gain),(c=H.createGain()).gain.value=y.lfo2ptc,d.connect(c),c.connect(x.detune));if(k){var A=H.createBiquadFilter();A.type="lowpass",A.frequency.value=y.filter}if(E){var B=1;(u=H.createGain()).gain.setValueAtTime(0,n),u.gain.linearRampToValueAtTime(B,n+y.envatt),m=y.envhld,v=y.envdec,h=0,a>m&&(u.gain.setValueAtTime(B,n+m),a<v?(h=a-m,g=y.envsus*(h/(v-m))):(h=v-m,g=y.envsus),B*=g,u.gain.linearRampToValueAtTime(B,n+m+h)),u.gain.setValueAtTime(B,n+a),b=n+a+(_=B)*y.envrel,u.gain.linearRampToValueAtTime(0,b),(f=H.createConstantSource()).offset.value=y.env2flt,f.connect(u),u.connect(A.detune)}pe&&((p=H.createStereoPanner()).pan.value=T);0==(B=r*L*y.atten*fe)&&(B=1e-5);(i=H.createGain()).gain.setValueAtTime(1e-5,n),i.gain.exponentialRampToValueAtTime(B,n+y.attack),m=y.hold,v=y.decay,h=0,a>m&&(i.gain.setValueAtTime(B,n+m),a<v?(h=a-m,g=Math.pow(10,Math.log10(y.sustain)*(h/(v-m)))):(h=v-m,g=y.sustain),B*=g,i.gain.exponentialRampToValueAtTime(B,n+m+h));i.gain.setValueAtTime(B,n+a),_=(100+20*Math.log10(B))/100,b=n+a+_*y.release,i.gain.exponentialRampToValueAtTime(1e-5,b),k?(x.connect(A),A.connect(p||i)):x.connect(p||i);p&&p.connect(i);w?(i.connect(s),s.connect(H.destination)):i.connect(H.destination);x.start(n),w&&d.start(n+y.lfodel);E&&f.start(n);x.stop(b),w&&d.stop(b);E&&f.stop(b)}(r,t%128,e/1e3,(n-1)/1e3,a,o);else{var i=[144,t,o];Ce(i,e,a),i[2]=0,Ce(i,e+n-1,a)}}}function Ce(e,t,n){if(0!=w){var a=240&e[0],o=e[2],r=e[1];t/=1e3,128==a&&Oe(r,t),144==a&&(o>0?function(e,t,n,a){var o,r=J[a]/127,i=(W[a]-64)/64,l=H.createBufferSource();l.buffer=z[e];var s=H.createGain();s.gain.setValueAtTime(1e-5,n);var c=t*r*ue;0==c&&(c=1e-5);s.gain.exponentialRampToValueAtTime(c,n+.001),pe&&((o=H.createStereoPanner()).pan.value=i);l.connect(o||s),o&&o.connect(s);s.connect(H.destination),l.start(n),q[e]=[l,s,c]}(r,o,t,n):Oe(r,t))}}function Oe(e,t){var n=q[e],a=n[0],o=n[1],r=n[2];a&&(o.gain.setValueAtTime(r,t),o.gain.exponentialRampToValueAtTime(1e-5,t+.1),a.stop(t+.1),q[e]=void 0)}function Re(e){return new Promise(function(t,n){for(var a=atob(e),o=new ArrayBuffer(a.length),r=new Uint8Array(o),i=0;i<a.length;i++)r[i]=a.charCodeAt(i);H.decodeAudioData(o,function(e){t(e)},function(e){n({err:1,msg:e,data:""})})})}function De(e){return new Promise(function(t,n){ie[e]=[];re[e]=[];function a(o){var r,i,l,s,c,d;r=instData[o];i={attack:r.attack,hold:r.hold,decay:r.decay,sustain:r.sustain,release:r.release,atten:r.atten,filter:r.filter,lfodel:r.lfodel,lfofreq:r.lfofreq,lfo2ptc:r.lfo2ptc,lfo2vol:r.lfo2vol,envatt:r.envatt,envhld:r.envhld,envdec:r.envdec,envsus:r.envsus,envrel:r.envrel,env2flt:r.env2flt,uselfo:me&&r.lfofreq>.008&&(r.lfo2ptc!=0||r.lfo2vol!=0),useflt:ve&&r.filter<16e3,useenv:he&&r.filter<16e3&&r.env2flt!=0};if(r.loopStart){i.loopStart=r.loopStart;i.loopEnd=r.loopEnd}s=r.scale;c=r.tune;for(var u=r.keyRangeLo;u<=r.keyRangeHi;u++){ie[e][u]=Math.pow(Math.pow(2,1/12),(u+c)*s);re[e][u]=i;F[e*128+u]=1}Re(r.sample).then(function(e){i.buffer=e;if(o<instData.length-1)a(o+1);else{instData="";t("ok")}}).catch(function(e){n(e)})}a(1)})}function Ve(e){return new Promise(function(t,n){var a=document.createElement("script");a.src=instUrl+"instr"+e+"mp3.js";a.onload=function(){t("ok");document.head.removeChild(a)};a.onerror=function(t){n({err:2,msg:"could not load "+a.src,data:e})};document.head.appendChild(a)})}function He(e){switch(null==e.err&&(e.err=4,e.msg=e.toString()),ge(e.err+", "+e.msg+", "+e.data),e.err){case 1:alert("Your browser does not support decoding ogg/vorbis -> no playback");break;case 2:var t="Loading javascript soundfont failed, instrument "+e.data+"\nfalling back to midi-js";ge(t),c.innerHTML+=t.replace("\n","<br>");break;case 3:ge("Loading midi-js soundfont failed, instrument "+e.data+"\nmsg: "+e.msg);break;case 4:alert(e.msg)}}function ze(e){function t(e){return new Promise(function(t,n){if(X[e]){t("ok");return}var a,o="https://rawgit.com/gleitz/midi-js-soundfonts/gh-pages/FluidR3_GM/";if(U[e])a=o+d+"-mp3";else{d=e in instTab?instTab[e]:d;a=instUrl+d+"-mp3"}c.innerHTML+=", loading: "+e;var i=document.createElement("script");i.src=a+".js";i.onload=function(){X[e]=MIDI.Soundfont[d];te[a]=1;ge("midi-js instr "+r+" geladen");t("ok")};i.onerror=function(){n({err:3,msg:"could not load:"+a,data:e})};if(a in te){t("ok");return}document.head.appendChild(i)})}function n(a){t(a).then(function(){var e=X[a][l+s].split(",")[1];return Re(e)}).then(function(t){z[o]=t;c.innerHTML+=", "+a+":"+i;F[o]=1;ze(e)}).catch(function(e){He(e);if(e.msg.indexOf("gleitz")==-1){U[a]=1;c.innerHTML+="<br>loading local midi-js font failed, instrument: "+e.data+"<br>trying Github ...";n(a)}else{alert("loading soundfont from Github failed, giving up.");c.style.display="none"}})}var a="C Db D Eb E F Gb G Ab A Bb B".split(" ");var o=e.shift();if(!o){w=1;c.style.display="none";return}var r=o>>7;var i=o%128;var l=a[i%12];var s=Math.floor(i/12)-1;var d=ee[r];if(Y[r]){ze(e);return}if(le&&!N[r]){Ve(r).then(function(){c.innerHTML+="loading instrument "+r+"<br>";return De(r)}).then(function(){ge("instr "+r+" geladen");Y[r]=1;ze(e)}).catch(function(e){He(e);N[r]=1;n(r)})}else{n(r)}}function qe(e){var t=Object.keys(e).filter(function(e){return!(e in F)});if(t.length){c.innerHTML="";c.style.display="block";ze(t)}}function Fe(){var e=document.documentElement.clientHeight,t=d.clientHeight;t=Math.round(100*t/e),Q.style.height=P-t+"%"}function Pe(){var t="",n="";if(e&&(new Abc({imagesize:'width="100%"',img_out:function(e){t+=e},errmsg:function(e,t,a){n+=e+"\n"},read_file:null,anno_start:null,get_abcmodel:null}).tosvg("abc2svg",e),""==n&&(n="no error\n"),ge(n),t)){var a,r,i='<html><meta charset="utf-8"><div>\n'+t+"\n</div></html>\n";r=o+".html";try{(a=document.createElement("a")).href="data:text/plain;charset=utf-8,"+encodeURIComponent(i),a.download=r,a.text="Save ABC file",document.getElementById("saveDiv").appendChild(a),a.click()}catch(e){if(!confirm("Do you want to save the ABC text?"))return;document.open("text/html"),document.write("<pre>"+i+"</pre>"),document.close()}}}function je(e,t,n){function a(t){e.removeEventListener("mousedown",a),e.removeEventListener("touchend",a),console.log("event listeners removed from "+e.nodeName+"#"+e.id),H&&"suspended"==H.state&&H.resume().then(function(){console.log("resuming audioContext")})}e.addEventListener("mousedown",a),e.addEventListener("touchend",a),e.addEventListener(t,n)}function Ge(){function e(e){v.checked=!e,v.disabled=e,h.style.color=e?"#aaa":"#000"}if("undefined"==typeof Dropbox){e(!0);var t=document.createElement("script");t.src="https://www.dropbox.com/static/api/2/dropins.js",t.onload=function(){e(!1),Dropbox.init({appKey:"ckknarypgq10318"});var t=Dropbox.createChooseButton({success:ye,cancel:function(){},linkType:"direct",multiselect:!1,extensions:[".xml",".abc"]});u.append(t),Ge()},t.onerror=function(){ge("loading dropbox API failed")},document.head.appendChild(t)}else document.querySelector(".dropbox-dropin-btn").style.display=v.checked?"inline-block":"none",p.style.display=v.checked?"none":"inline-block"}function Ne(){var e=document.body,t=e.requestFullscreen||e.mozRequestFullScreen||e.webkitRequestFullscreen,n=document.exitFullscreen||document.mozCancelFullScreen||document.webkitExitFullscreen;t&&n&&($("#fscr").prop("checked")?t.call(e):n.call(document))}document.addEventListener("DOMContentLoaded",function(){c=document.getElementById("comp"),Q=document.getElementById("notation"),d=document.getElementById("err"),f=document.getElementById("rollijn"),u=document.getElementById("abcfile"),p=document.getElementById("fknp"),m=document.getElementById("tempo"),b=document.getElementById("playbk"),y=document.getElementById("play"),document.getElementById("kwart").appendChild(document.getElementById("mtrsvg")),je(y,"click",Ie),je(b,"click",Ie),p.addEventListener("change",be),document.getElementById("save").addEventListener("click",Pe),f.addEventListener("mousedown",Le),f.addEventListener("touchstart",Le),m.addEventListener("change",Se),window.addEventListener("resize",function(){we(),Fe(),Ee()}),Q.addEventListener("drop",xe),Q.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}),Q.addEventListener("dragenter",function(){this.classList.add("indrag")}),Q.addEventListener("dragleave",function(){this.classList.remove("indrag")}),(v=document.getElementById("drpuse")).checked=!1,v.addEventListener("click",Ge),h=document.getElementById("drplbl"),g=document.getElementById("mbar"),(_=document.getElementById("menu")).style.display="none",g.addEventListener("click",function(e){e.stopPropagation();var t="none"==_.style.display;_.style.display=t?"block":"none",g.style.background=t?"#aaa":""}),_.addEventListener("click",function(e){e.stopPropagation()}),i=CSS.supports("scroll-behavior","smooth"),function(){var e,t,n,a,o,r,l,s,c,u="",p="",m={};if(d.innerHTML="",(e=window.location.href.replace("?dl=0","").split("?")).length>1)for(t=e[1].split("&"),l=0;l<t.length;l++)"noErr"==(m=t[l].replace(/d:(\w{15}\/[^.]+\.)/,"https://dl.dropboxusercontent.com/s/$1"))?o=1:"noMenu"==m?n=1:"noSave"==m?a=1:"noErr"==m?o=1:"noDash"==m?r=1:"noRT"==m?le=0:"noPF"==m?se=1:"noLB"==m?ce=1:(c=m.match(/noCur=([\da-fA-F]{2})/))?de=parseInt(c[1],16):"nosm"==m?i=!1:p=m;if(null!=(m=(s=document.getElementById("parms"))?JSON.parse(s.innerHTML):{}).topSpace&&(M=m.topSpace),null!=m.notationHeight&&(P=m.notationHeight),null!=m.fileURL&&(p=m.fileURL),null!=m.gTempo&&(ne=m.gTempo),null!=m.noCur&&(de=m.noCur),(null!=m.noDash&&m.noDash||r)&&(f.style.visibility="hidden"),(null!=m.noSave&&m.noSave||a)&&(document.getElementById("savlbl").style.display="none"),(null!=m.noMenu&&m.noMenu||n)&&(document.getElementById("mbar").style.display="none"),(null!=m.noErr&&m.noErr||o)&&(d.style.display="none",d.style.height="0px"),/(\.xml$)|(\.abc$)/.test(p)&&(u=p,p=""),u){var v=document.getElementById("wait");v.style.display="block";var h=new XMLHttpRequest;h.open("GET",u,!0),h.onload=function(){ge("preload ok"),_e(h.response),b.style.display="block",v.style.display="none"},h.onerror=function(){v.innerHTML+="\npreload failed"},h.send()}}(),Fe();var e=window.AudioContext||window.webkitAudioContext;if(H=null!=e?new e:null){H.createStereoPanner||(pe=0),H.createOscillator||(me=0),H.createBiquadFilter||(ve=0),H.createConstantSource||(he=0);var t=[],n=0,a="Your browser does not support ";pe||t.push(a+"the StereoPanner element"),le&&!me&&(t.push(a+"the Oscillator element"),n=1),le&&!ve&&(t.push(a+"the BiquadFilter element"),n=1),le&&!he&&(t.push(a+"the ConstantSource element"),n=1),t.length&&alert(t.join("\n")+(n?"\nThe instrument(s) will sound (very) wrong":""))}else alert(Z);i||alert("Your browser does not support smooth scrolling"),document.getElementById("verlab").innerHTML="<span>Version:</span>"+xmlplay_VERSION,$("#fscr").on("change",Ne),$("body").on("fullscreenchange webkitfullscreenchange mozfullscreenchange",function(){var e=document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement;$("#fscr").prop("checked",null!=e)}),document.body.addEventListener("keydown",Be)})}();
